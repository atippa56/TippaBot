<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Enhanced Trading Bot - Dark Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --bg-card: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --accent-primary: #00d4aa;
            --accent-secondary: #ff6b6b;
            --accent-warning: #ffa726;
            --border-color: #333333;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --gradient-primary: linear-gradient(135deg, #00d4aa 0%, #0099cc 100%);
            --gradient-secondary: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 2.5em;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .status-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .status-card h3 {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .status-card .value {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .status-card.running .value {
            color: var(--accent-primary);
        }

        .status-card.stopped .value {
            color: var(--accent-secondary);
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 170, 0.3);
        }

        .btn-danger {
            background: var(--gradient-secondary);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            transform: translateY(-2px);
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 5px;
            border: 1px solid var(--border-color);
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
        }

        .tab-button:hover:not(.active) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Watchlist Tab */
        .watchlist-section {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .add-crypto-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .add-crypto-form input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .add-crypto-form input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        .add-crypto-form input::placeholder {
            color: var(--text-muted);
        }

        .crypto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .crypto-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .crypto-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .crypto-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            border-color: var(--accent-primary);
        }

        .crypto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .crypto-symbol {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .crypto-price {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .crypto-change {
            font-size: 0.9em;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 8px;
        }

        .crypto-change.positive {
            background: rgba(0, 212, 170, 0.2);
            color: var(--accent-primary);
        }

        .crypto-change.negative {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-secondary);
        }

        .crypto-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .crypto-stat {
            text-align: center;
        }

        .crypto-stat-label {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .crypto-stat-value {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .crypto-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .btn-icon:hover {
            background: var(--accent-secondary);
            color: white;
        }

        /* Trades Tab */
        .trades-section {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .trades-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .trades-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
        }

        .trades-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .trades-header h3 {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .btn-clear {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-secondary);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-clear:hover {
            background: var(--accent-secondary);
            color: white;
            border-color: var(--accent-secondary);
        }

        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .trade-item:last-child {
            border-bottom: none;
        }

        .trade-info {
            flex: 1;
        }

        .trade-symbol {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .trade-details {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .trade-amount {
            text-align: right;
        }

        .trade-value {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .trade-pnl {
            font-size: 0.9em;
            font-weight: 600;
        }

        .trade-pnl.positive {
            color: var(--accent-primary);
        }

        .trade-pnl.negative {
            color: var(--accent-secondary);
        }

        .position-status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .position-status.open {
            background: rgba(0, 212, 170, 0.2);
            color: var(--accent-primary);
        }

        .position-status.closed {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-secondary);
        }

        /* Full Screen Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        /* MODAL STYLES - Make modal full screen, dark, and immersive */
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10,10,10,0.98);
            z-index: 1000;
        }
        .modal-content {
            width: 90vw;
            max-width: 1200px;
            height: 90vh;
            max-height: 800px;
            background: #181a20;
            border-radius: 18px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.7);
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #23272f;
            padding: 32px 40px 24px 40px;
            border-bottom: 1px solid #23272f;
        }
        .modal-title {
            font-size: 2.2em;
            font-weight: 800;
            color: #fff;
            letter-spacing: 1px;
        }
        .modal-stats-row {
            display: flex;
            align-items: center;
            gap: 32px;
        }
        .modal-price {
            font-size: 2.5em;
            font-weight: 900;
            color: #00d4aa;
            margin-right: 24px;
        }
        .modal-stat {
            font-size: 1.1em;
            color: #b0b0b0;
            margin-right: 18px;
        }
        .modal-stat.negative { color: #ff6b6b; }
        .modal-stat.positive { color: #00d4aa; }
        .modal-close {
            background: #23272f;
            border: none;
            border-radius: 50%;
            width: 44px; height: 44px;
            color: #b0b0b0;
            font-size: 1.5em;
            cursor: pointer;
            transition: background 0.2s;
        }
        .modal-close:hover { background: #ff6b6b; color: #fff; }
        .modal-chart-area {
            flex: 1;
            background: #181a20;
            padding: 32px 40px 40px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chart-container {
            position: relative;
            height: 100%;
            min-height: 350px;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .message.success {
            background: rgba(0, 212, 170, 0.1);
            color: var(--accent-primary);
            border: 1px solid rgba(0, 212, 170, 0.3);
        }

        .message.error {
            background: rgba(255, 107, 107, 0.1);
            color: var(--accent-secondary);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .search-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s ease;
        }

        .search-item:hover {
            background: var(--bg-card);
        }

        .search-item:last-child {
            border-bottom: none;
        }

        .search-item .crypto-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .search-item .crypto-id {
            font-size: 12px;
            color: var(--text-muted);
        }

        .no-results {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .no-data i {
            font-size: 3em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading i {
            font-size: 2em;
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .trades-grid {
                grid-template-columns: 1fr;
            }
            
            .crypto-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls {
                flex-direction: column;
            }
            
            .crypto-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 20px;
                padding: 20px;
            }
            
            .modal-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        .modal-range-row { display: flex; gap: 8px; margin-top: 10px; }
        .modal-range-btn {
            background: #23272f;
            color: #b0b0b0;
            border: none;
            border-radius: 7px;
            padding: 7px 18px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .modal-range-btn.active, .modal-range-btn:hover {
            background: #00d4aa;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-rocket"></i> Tippa Bot</h1>
            <div class="status-grid">
                <div class="status-card" id="status-card">
                    <h3><i class="fas fa-circle"></i> Status</h3>
                    <div class="value" id="bot-status">Loading...</div>
                </div>
                <div class="status-card">
                    <h3><i class="fas fa-chart-line"></i> Open Positions</h3>
                    <div class="value" id="open-positions">0</div>
                </div>
                <div class="status-card">
                    <h3><i class="fas fa-dollar-sign"></i> Total PnL</h3>
                    <div class="value" id="total-pnl">$0.00</div>
                </div>
                <div class="status-card">
                    <h3><i class="fas fa-exchange-alt"></i> Total Trades</h3>
                    <div class="value" id="total-trades">0</div>
                </div>
                <div class="status-card">
                    <h3><i class="fas fa-shield-alt"></i> Mode</h3>
                    <div class="value" id="trading-mode">PAPER</div>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-secondary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        <div class="message error" style="margin-bottom: 24px; font-size: 1.15em; text-align: center;">
            <i class="fas fa-info-circle"></i> <b>Demo Mode:</b> You are viewing Tippa Bot in demo mode. Customization is disabled, but you can freely use the cryptocurrency watchlist and, if the bot is running, view live trades (or paper trades if I'm currently testing.)
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('watchlist')">
                <i class="fas fa-star"></i> Watchlist
            </button>
            <button class="tab-button" onclick="switchTab('trades')">
                <i class="fas fa-chart-bar"></i> Trades & Positions
            </button>
            <!-- Add Bot Customization tab to nav bar -->
            <button class="tab-button" onclick="showCustomizationTab()">Bot Customization</button>
        </div>

        <!-- Watchlist Tab -->
        <div id="watchlist-tab" class="tab-content active">
            <div class="watchlist-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-star"></i> Crypto Watchlist</h2>
                </div>
                
                <div id="message"></div>
                
                <div class="add-crypto-form">
                    <input type="text" id="crypto-search" placeholder="Search cryptocurrencies..." oninput="searchCryptos()">
                    <button class="btn btn-primary" onclick="searchCryptos()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                
                <div id="search-results" class="search-results" style="display: none;"></div>
                
                <div id="crypto-grid" class="crypto-grid">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <div>Loading watchlist...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trades Tab -->
        <div id="trades-tab" class="tab-content">
            <div class="trades-section">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-chart-bar"></i> Trading Activity</h2>
                </div>
                
                <div class="trades-grid">
                    <div class="trades-card">
                        <h3><i class="fas fa-door-open"></i> Open Positions</h3>
                        <div id="open-positions-list">
                            <div class="loading">
                                <i class="fas fa-spinner"></i>
                                <div>Loading positions...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trades-card">
                        <div class="trades-header">
                            <h3><i class="fas fa-history"></i> Recent Trades</h3>
                            <button class="btn-clear" onclick="clearTrades()" title="Clear recent trades">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                        <div id="recent-trades-list">
                            <div class="loading">
                                <i class="fas fa-spinner"></i>
                                <div>Loading trades...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Screen Modal -->
    <div id="crypto-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="modal-title">Bitcoin</div>
                    <div class="modal-stats-row">
                        <span class="modal-price" id="modal-price">$0.00</span>
                        <span class="modal-stat" id="modal-change">0.00%</span>
                        <span class="modal-stat" id="modal-volume">$0.00</span>
                        <span class="modal-stat" id="modal-mcap">$0.00</span>
                    </div>
                    <div class="modal-range-row" style="margin-top:18px;">
                        <button class="modal-range-btn" data-range="1D">1D</button>
                        <button class="modal-range-btn" data-range="1W">1W</button>
                        <button class="modal-range-btn" data-range="1M">1M</button>
                        <button class="modal-range-btn" data-range="1Y">1Y</button>
                        <button class="modal-range-btn" data-range="5Y">5Y</button>
                    </div>
                </div>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-chart-area">
                <div class="chart-container">
                    <canvas id="modal-chart"></canvas>
                </div>
                <div id="modal-trades-section" style="margin-top:32px;">
                    <h3 style="color:#fff;font-size:1.1em;margin-bottom:10px;">Live Exchange Trades</h3>
                    <div id="modal-trades-table" style="background:#20232a;border-radius:10px;padding:12px 0;overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;color:#b0b0b0;font-size:0.98em;">
                            <thead>
                                <tr style="border-bottom:1px solid #23272f;">
                                    <th style="padding:6px 12px;text-align:left;">Price (USDT)</th>
                                    <th style="padding:6px 12px;text-align:left;">Amount</th>
                                    <th style="padding:6px 12px;text-align:left;">Time</th>
                                </tr>
                            </thead>
                            <tbody id="modal-trades-tbody">
                                <tr><td colspan="3" style="text-align:center;color:#666;padding:12px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add modal for password entry and admin actions -->
    <div id="customization-modal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <span class="close" onclick="closeCustomizationModal()">&times;</span>
        <div id="customization-login" style="display:block;">
          <h3>Admin Login</h3>
          <input type="password" id="admin-password" placeholder="Enter password">
          <button onclick="verifyAdminPassword()" class="btn btn-primary">Login</button>
          <div id="admin-login-error" style="color:red;display:none;">Incorrect password.</div>
        </div>
        <div id="customization-panel" style="display:none;">
          <h3>Bot Customization</h3>
          <div style="margin-bottom: 20px;">
            <span id="trading-status"></span>
            <span id="bot-balance" style="font-size:1.3em;font-weight:600;margin-left:20px;"></span>
          </div>
          <div style="display:flex;gap:20px;margin-bottom:20px;">
            <button onclick="startBot()" class="btn btn-primary" style="background:linear-gradient(135deg,#00d46a 0%,#00cc44 100%);color:white;font-size:1.1em;padding:16px 32px;">
              <i class="fas fa-play"></i> Start Bot
            </button>
            <button onclick="stopBot()" class="btn btn-danger" style="background:linear-gradient(135deg,#ff6b6b 0%,#ee5a24 100%);color:white;font-size:1.1em;padding:16px 32px;">
              <i class="fas fa-stop"></i> Stop Bot
            </button>
          </div>
          <button onclick="logoutAdmin()" class="btn btn-secondary">Logout</button>
        </div>
      </div>
    </div>

    <script>
        let currentData = {};
        let pendingSymbols = [];
        let selectedCrypto = null;
        let modalChart = null;
        let refreshInterval;

        // Add mapping from CoinGecko ID to Binance symbol
        const COINGECKO_TO_BINANCE = {
            'bitcoin': 'BTCUSDT',
            'ethereum': 'ETHUSDT',
            'binancecoin': 'BNBUSDT',
            'cardano': 'ADAUSDT',
            'solana': 'SOLUSDT',
            'polkadot': 'DOTUSDT',
            'dogecoin': 'DOGEUSDT',
            'avalanche-2': 'AVAXUSDT',
            'chainlink': 'LINKUSDT',
            'matic-network': 'MATICUSDT'
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshDataProgressive();
            refreshInterval = setInterval(refreshDataProgressive, 10000); // Refresh every 10 seconds
        });

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Refresh data for the selected tab
            if (tabName === 'trades') {
                refreshTradesData();
            }
        }

        async function refreshDataProgressive() {
            try {
                // Update status
                const statusResponse = await fetch('/api/status');
                const statusData = await statusResponse.json();
                updateStatus(statusData);

                // Get custom symbols for the watchlist
                const customSymbols = statusData.custom_symbols || [];
                let marketData = {};
                let pendingSymbols = [];
                if (customSymbols.length > 0) {
                    // Fetch market data directly for all watchlist symbols
                    const directResp = await fetch('/api/market_data_direct', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ symbols: customSymbols })
                    });
                    const directData = await directResp.json();
                    if (directData.data) {
                        marketData = directData.data;
                    } else {
                        // fallback: mark all as pending if error
                        pendingSymbols = customSymbols;
                    }
                }
                updateWatchlist(customSymbols, marketData, pendingSymbols);
                // Update positions and trades
                await refreshTradesData();
            } catch (error) {
                console.error('Error refreshing data:', error);
                showMessage('Error refreshing data: ' + error.message, 'error');
            }
        }

        async function refreshTradesData() {
            try {
                // Get positions and trades
                const positionsResponse = await fetch('/api/positions');
                const positionsData = await positionsResponse.json();
                
                const tradesResponse = await fetch('/api/trades');
                const tradesData = await tradesResponse.json();
                
                updatePositions(positionsData);
                updateTrades(tradesData);
            } catch (error) {
                console.error('Error refreshing trades data:', error);
            }
        }

        function updateStatus(data) {
            const statusCard = document.getElementById('status-card');
            const statusElement = document.getElementById('bot-status');
            
            if (data.is_running) {
                statusElement.textContent = 'Running';
                statusCard.className = 'status-card running';
            } else {
                statusElement.textContent = 'Stopped';
                statusCard.className = 'status-card stopped';
            }
            
            document.getElementById('open-positions').textContent = data.open_positions;
            
            // Calculate percentage PnL based on initial balance
            const initialBalance = 10000.0; // Starting balance
            const pnlPercent = initialBalance > 0 ? (data.total_pnl / initialBalance) * 100 : 0;
            
            // Format total PnL with percentage
            let totalPnlDisplay;
            if (Math.abs(data.total_pnl) < 0.01 && data.total_pnl !== 0) {
                totalPnlDisplay = `$${data.total_pnl.toFixed(4)} (${pnlPercent.toFixed(2)}%)`;
            } else if (Math.abs(data.total_pnl) < 0.1) {
                totalPnlDisplay = `$${data.total_pnl.toFixed(3)} (${pnlPercent.toFixed(2)}%)`;
            } else {
                totalPnlDisplay = `$${data.total_pnl.toFixed(2)} (${pnlPercent.toFixed(2)}%)`;
            }
            document.getElementById('total-pnl').textContent = totalPnlDisplay;
            
            document.getElementById('total-trades').textContent = data.total_trades;
            document.getElementById('trading-mode').textContent = data.trading_mode;
        }

        function updateWatchlist(customSymbols, marketData, pending=[]) {
            const cryptoGrid = document.getElementById('crypto-grid');
            if (!customSymbols || customSymbols.length === 0) {
                cryptoGrid.innerHTML = '<div class="no-data"><i class="fas fa-plus-circle"></i><div>No cryptocurrencies in watchlist<br><small>Search and add cryptocurrencies above</small></div></div>';
                return;
            }
            cryptoGrid.innerHTML = '';
            customSymbols.forEach(symbol => {
                const cryptoCard = document.createElement('div');
                cryptoCard.className = 'crypto-card';
                const data = marketData[symbol];
                if (data) {
                    // We have market data, show full card
                    cryptoCard.onclick = () => openCryptoModal(symbol, data);
                    const changeClass = data.change_24h >= 0 ? 'positive' : 'negative';
                    const changeSymbol = data.change_24h >= 0 ? '+' : '';
                    cryptoCard.innerHTML = `
                        <div class="crypto-header">
                            <div class="crypto-symbol">${symbol.toUpperCase()}</div>
                            <div class="crypto-price">$${data.price.toFixed(2)}</div>
                        </div>
                        <div class="crypto-stats">
                            <div class="crypto-stat">
                                <div class="crypto-stat-label">24h Change</div>
                                <div class="crypto-change ${changeClass}">${changeSymbol}${data.change_24h.toFixed(2)}%</div>
                            </div>
                            <div class="crypto-stat">
                                <div class="crypto-stat-label">Volume</div>
                                <div class="crypto-stat-value">$${(data.volume_24h / 1000000).toFixed(1)}M</div>
                            </div>
                        </div>
                        <div class="crypto-actions">
                            <button class="btn-icon" onclick="event.stopPropagation(); removeCrypto('${symbol}')">
                                <i class="fas fa-times"></i>
                            </button>
                            <span class="crypto-change ${changeClass}">${changeSymbol}${data.change_24h.toFixed(2)}%</span>
                        </div>
                    `;
                } else if (pending.includes(symbol)) {
                    // Pending data
                    cryptoCard.innerHTML = `
                        <div class="crypto-header">
                            <div class="crypto-symbol">${symbol.toUpperCase()}</div>
                            <div class="crypto-price">Loading...</div>
                        </div>
                        <div class="crypto-stats">
                            <div class="crypto-stat">
                                <div class="crypto-stat-label">Status</div>
                                <div class="crypto-stat-value">Pending</div>
                            </div>
                        </div>
                        <div class="crypto-actions">
                            <button class="btn-icon" onclick="event.stopPropagation(); removeCrypto('${symbol}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                } else {
                    // Fallback
                    cryptoCard.innerHTML = `
                        <div class="crypto-header">
                            <div class="crypto-symbol">${symbol.toUpperCase()}</div>
                            <div class="crypto-price">Unavailable</div>
                        </div>
                        <div class="crypto-stats">
                            <div class="crypto-stat">
                                <div class="crypto-stat-label">Status</div>
                                <div class="crypto-stat-value">Unavailable</div>
                            </div>
                        </div>
                        <div class="crypto-actions">
                            <button class="btn-icon" onclick="event.stopPropagation(); removeCrypto('${symbol}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }
                cryptoGrid.appendChild(cryptoCard);
            });
        }

        function updatePositions(positions) {
            const positionsList = document.getElementById('open-positions-list');
            
            if (!positions || positions.length === 0) {
                positionsList.innerHTML = '<div class="no-data"><i class="fas fa-door-closed"></i><div>No open positions</div></div>';
                return;
            }
            
            positionsList.innerHTML = '';
            
            positions.forEach(position => {
                const tradeItem = document.createElement('div');
                tradeItem.className = 'trade-item';
                
                // Calculate current value and PnL
                const currentValue = position.quantity * position.current_price;
                const entryValue = position.quantity * position.entry_price;
                const pnl = position.unrealized_pnl || 0;
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                const pnlSymbol = pnl >= 0 ? '+' : '';
                
                // Calculate percentage PnL
                const pnlPercent = entryValue > 0 ? (pnl / entryValue) * 100 : 0;
                
                // Format PnL display - show both dollar and percentage
                let pnlDisplay;
                if (Math.abs(pnl) < 0.01 && pnl !== 0) {
                    pnlDisplay = `$${pnl.toFixed(4)} (${pnlPercent.toFixed(2)}%)`;
                } else if (Math.abs(pnl) < 0.1) {
                    pnlDisplay = `$${pnl.toFixed(3)} (${pnlPercent.toFixed(2)}%)`;
                } else {
                    pnlDisplay = `$${pnl.toFixed(2)} (${pnlPercent.toFixed(2)}%)`;
                }
                
                tradeItem.innerHTML = `
                    <div class="trade-info">
                        <div class="trade-symbol">${position.symbol.toUpperCase()}</div>
                        <div class="trade-details">
                            ${position.side} • ${position.quantity.toFixed(4)} @ $${position.entry_price.toFixed(2)}
                        </div>
                    </div>
                    <div class="trade-amount">
                        <div class="trade-value">$${currentValue.toFixed(2)}</div>
                        <div class="trade-pnl ${pnlClass}">${pnlSymbol}${pnlDisplay}</div>
                    </div>
                `;
                
                positionsList.appendChild(tradeItem);
            });
        }

        function updateTrades(trades) {
            const tradesList = document.getElementById('recent-trades-list');
            
            if (!trades || trades.length === 0) {
                tradesList.innerHTML = '<div class="no-data"><i class="fas fa-history"></i><div>No recent trades</div></div>';
                return;
            }
            
            tradesList.innerHTML = '';
            
            // Show only the most recent 10 trades
            const recentTrades = trades.slice(0, 10);
            
            recentTrades.forEach(trade => {
                const tradeItem = document.createElement('div');
                tradeItem.className = 'trade-item';
                
                // Calculate total value and PnL
                const totalValue = trade.quantity * trade.price;
                const pnl = trade.pnl || 0;
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                const pnlSymbol = pnl >= 0 ? '+' : '';
                
                // Calculate percentage PnL for closed trades
                const pnlPercent = totalValue > 0 ? (pnl / totalValue) * 100 : 0;
                
                // Format PnL display - show both dollar and percentage
                let pnlDisplay;
                if (Math.abs(pnl) < 0.01 && pnl !== 0) {
                    pnlDisplay = `$${pnl.toFixed(4)} (${pnlPercent.toFixed(2)}%)`;
                } else if (Math.abs(pnl) < 0.1) {
                    pnlDisplay = `$${pnl.toFixed(3)} (${pnlPercent.toFixed(2)}%)`;
                } else {
                    pnlDisplay = `$${pnl.toFixed(2)} (${pnlPercent.toFixed(2)}%)`;
                }
                
                // Format timestamp in 12-hour format (timestamps are already in local timezone)
                const tradeDate = new Date(trade.timestamp);
                const localTime = tradeDate.toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
                
                tradeItem.innerHTML = `
                    <div class="trade-info">
                        <div class="trade-symbol">${trade.symbol.toUpperCase()}</div>
                        <div class="trade-details">
                            ${trade.side} • ${trade.quantity.toFixed(4)} @ $${trade.price.toFixed(2)}
                            <br><small>${localTime}</small>
                        </div>
                    </div>
                    <div class="trade-amount">
                        <div class="trade-value">$${totalValue.toFixed(2)}</div>
                        <div class="trade-pnl ${pnlClass}">${pnlSymbol}${pnlDisplay}</div>
                        <div class="trade-strategy">${trade.strategy}</div>
                    </div>
                `;
                
                tradesList.appendChild(tradeItem);
            });
        }

        function openCryptoModal(symbol, data) {
            selectedCrypto = symbol;
            modalCurrentRange = '1D';
            // Set modal header
            document.getElementById('modal-title').textContent = symbol.toUpperCase();
            document.getElementById('modal-price').textContent = `$${data.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            const changeElement = document.getElementById('modal-change');
            const changeClass = data.change_24h >= 0 ? 'positive' : 'negative';
            changeElement.textContent = `${data.change_24h >= 0 ? '+' : ''}${data.change_24h.toFixed(2)}%`;
            changeElement.className = `modal-stat ${changeClass}`;
            document.getElementById('modal-volume').textContent = `$${(data.volume_24h / 1000000).toFixed(1)}M`;
            document.getElementById('modal-mcap').textContent = `$${(data.market_cap / 1000000000).toFixed(1)}B`;
            document.getElementById('crypto-modal').classList.add('active');
            // Set range button active
            document.querySelectorAll('.modal-range-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-range') === modalCurrentRange) btn.classList.add('active');
                btn.onclick = () => { setModalRange(symbol, data, btn.getAttribute('data-range')); };
            });
            updateModalChart(symbol, data, modalCurrentRange);
            fetchBinanceTrades(symbol);
        }

        function setModalRange(symbol, data, range) {
            modalCurrentRange = range;
            document.querySelectorAll('.modal-range-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-range') === range) btn.classList.add('active');
            });
            updateModalChart(symbol, data, range);
            fetchBinanceTrades(symbol);
        }

        function closeModal() {
            document.getElementById('crypto-modal').classList.remove('active');
            if (modalChart) {
                modalChart.destroy();
                modalChart = null;
            }
        }

        async function updateModalChart(symbol, data, range) {
            const ctx = document.getElementById('modal-chart').getContext('2d');
            if (modalChart) modalChart.destroy();
            // Map range to CoinGecko days param
            let days = 1;
            if (range === '1W') days = 7;
            else if (range === '1M') days = 30;
            else if (range === '1Y') days = 365;
            else if (range === '5Y') days = 'max';
            // Fetch historical data from CoinGecko
            let prices = [], volumes = [], labels = [];
            try {
                const resp = await fetch(`https://api.coingecko.com/api/v3/coins/${symbol}/market_chart?vs_currency=usd&days=${days}`);
                const hist = await resp.json();
                if (hist.prices && hist.total_volumes) {
                    prices = hist.prices.map(p => p[1]);
                    volumes = hist.total_volumes.map(v => v[1]);
                    labels = hist.prices.map(p => {
                        const d = new Date(p[0]);
                        return days === 1 ? `${d.getHours()}:00` : `${d.getMonth()+1}/${d.getDate()}`;
                    });
                }
            } catch (e) {
                // fallback to current price
                prices = [data.price];
                volumes = [data.volume_24h];
                labels = ['Now'];
            }
            // Gradient for area
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0,212,170,0.4)');
            gradient.addColorStop(1, 'rgba(24,26,32,0.1)');
            modalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'line',
                            label: `${symbol.toUpperCase()} Price`,
                            data: prices,
                            borderColor: '#00d4aa',
                            backgroundColor: gradient,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#00d4aa',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2,
                            order: 2,
                            z: 2
                        },
                        {
                            type: 'bar',
                            label: 'Volume',
                            data: volumes,
                            backgroundColor: 'rgba(255,255,255,0.08)',
                            borderWidth: 0,
                            order: 1,
                            z: 1,
                            yAxisID: 'y1',
                            barPercentage: 0.8,
                            categoryPercentage: 1.0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.92)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#00d4aa',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.type === 'line') {
                                        return `Price: $${context.parsed.y.toFixed(2)}`;
                                    } else {
                                        return `Volume: ${context.parsed.y.toFixed(2)}M`;
                                    }
                                }
                            }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        x: {
                            grid: { color: '#23272f', drawBorder: false },
                            ticks: { color: '#b0b0b0', maxTicksLimit: 8, font: { size: 13 } }
                        },
                        y: {
                            grid: { color: '#23272f', drawBorder: false },
                            ticks: {
                                color: '#b0b0b0',
                                callback: function(value) { return '$' + value.toFixed(2); },
                                font: { size: 13 }
                            },
                            beginAtZero: false,
                            title: { display: true, text: 'Price', color: '#b0b0b0', font: { size: 13 } }
                        },
                        y1: {
                            position: 'right',
                            grid: { display: false },
                            ticks: { display: false },
                            beginAtZero: true,
                            min: 0,
                            max: Math.max(...volumes) * 1.2
                        }
                    }
                }
            });
        }

        async function searchCryptos() {
            const searchTerm = document.getElementById('crypto-search').value.toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            
            if (searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch('/api/custom_cryptos');
                const data = await response.json();
                if (!data.available || Object.keys(data.available).length === 0) {
                    resultsDiv.innerHTML = '<div class="no-results">Crypto search is temporarily unavailable. Please try again later.</div>';
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                // Define popular cryptocurrencies with their common names and symbols
                const popularCryptos = {
                    'bitcoin': ['btc', 'bitcoin', 'xbt'],
                    'ethereum': ['eth', 'ethereum'],
                    'binancecoin': ['bnb', 'binance', 'binance coin'],
                    'cardano': ['ada', 'cardano'],
                    'solana': ['sol', 'solana'],
                    'polkadot': ['dot', 'polkadot'],
                    'dogecoin': ['doge', 'dogecoin'],
                    'avalanche-2': ['avax', 'avalanche'],
                    'matic-network': ['matic', 'polygon'],
                    'chainlink': ['link', 'chainlink'],
                    'ripple': ['xrp', 'ripple'],
                    'litecoin': ['ltc', 'litecoin'],
                    'uniswap': ['uni', 'uniswap'],
                    'stellar': ['xlm', 'stellar'],
                    'cosmos': ['atom', 'cosmos'],
                    'monero': ['xmr', 'monero'],
                    'algorand': ['algo', 'algorand'],
                    'vechain': ['vet', 'vechain'],
                    'filecoin': ['fil', 'filecoin'],
                    'tron': ['trx', 'tron'],
                    'eos': ['eos', 'eos'],
                    'tezos': ['xtz', 'tezos'],
                    'neo': ['neo', 'neo'],
                    'dash': ['dash', 'dash'],
                    'zcash': ['zec', 'zcash'],
                    '0x': ['zrx', '0x protocol'],
                    'aave': ['aave', 'aave'],
                    'compound': ['comp', 'compound'],
                    'synthetix': ['snx', 'synthetix'],
                    'yearn-finance': ['yfi', 'yearn finance'],
                    'curve-dao-token': ['crv', 'curve'],
                    'sushi': ['sushi', 'sushiswap'],
                    'pancakeswap-token': ['cake', 'pancakeswap'],
                    'chiliz': ['chz', 'chiliz'],
                    'enjincoin': ['enj', 'enjin'],
                    'decentraland': ['mana', 'decentraland'],
                    'sandbox': ['sand', 'sandbox'],
                    'axie-infinity': ['axs', 'axie infinity'],
                    'gala': ['gala', 'gala games'],
                    'flow': ['flow', 'flow'],
                    'near': ['near', 'near protocol'],
                    'fantom': ['ftm', 'fantom'],
                    'harmony': ['one', 'harmony'],
                    'elrond-erd-2': ['egld', 'elrond'],
                    'hedera-hashgraph': ['hbar', 'hedera'],
                    'theta-token': ['theta', 'theta network'],
                    'iota': ['miota', 'iota'],
                    'nano': ['nano', 'nano'],
                    'icon': ['icx', 'icon'],
                    'ontology': ['ont', 'ontology'],
                    'qtum': ['qtum', 'qtum'],
                    'omisego': ['omg', 'omg network'],
                    '0x': ['zrx', '0x protocol'],
                    'augur': ['rep', 'augur'],
                    'basic-attention-token': ['bat', 'brave'],
                    'maker': ['mkr', 'makerdao'],
                    'dai': ['dai', 'dai stablecoin'],
                    'usd-coin': ['usdc', 'usd coin'],
                    'tether': ['usdt', 'tether'],
                    'true-usd': ['tusd', 'true usd'],
                    'paxos-standard': ['pax', 'paxos standard'],
                    'binance-usd': ['busd', 'binance usd']
                };
                
                // Score and sort results
                const scoredResults = Object.entries(data.available).map(([id, name]) => {
                    const idLower = id.toLowerCase();
                    const nameLower = name.toLowerCase();
                    let score = 0;
                    
                    // Exact matches get highest score
                    if (idLower === searchTerm) score += 1000;
                    if (nameLower === searchTerm) score += 1000;
                    
                    // Starts with search term
                    if (idLower.startsWith(searchTerm)) score += 500;
                    if (nameLower.startsWith(searchTerm)) score += 500;
                    
                    // Contains search term
                    if (idLower.includes(searchTerm)) score += 100;
                    if (nameLower.includes(searchTerm)) score += 100;
                    
                    // Popular crypto bonus
                    if (popularCryptos[id]) {
                        const popularNames = popularCryptos[id];
                        for (const popularName of popularNames) {
                            if (popularName.includes(searchTerm) || searchTerm.includes(popularName)) {
                                score += 200;
                                break;
                            }
                        }
                    }
                    
                    // Popular crypto names that match search term
                    for (const [popularId, popularNames] of Object.entries(popularCryptos)) {
                        for (const popularName of popularNames) {
                            if (popularName.includes(searchTerm) && id === popularId) {
                                score += 300;
                                break;
                            }
                        }
                    }
                    
                    return { id, name, score };
                }).filter(result => result.score > 0)
                  .sort((a, b) => b.score - a.score)
                  .slice(0, 15);
                
                resultsDiv.innerHTML = '';
                
                if (scoredResults.length === 0) {
                    resultsDiv.innerHTML = '<div class="no-results">No cryptocurrencies found</div>';
                } else {
                    scoredResults.forEach(({ id, name }) => {
                        const div = document.createElement('div');
                        div.className = 'search-item';
                        div.onclick = () => addCrypto(id);
                        div.innerHTML = `
                            <div class="crypto-name">${name}</div>
                            <div class="crypto-id">${id}</div>
                        `;
                        resultsDiv.appendChild(div);
                    });
                }
                
                resultsDiv.style.display = 'block';
            } catch (error) {
                console.error('Error searching cryptos:', error);
            }
        }

        async function addCrypto(cryptoId) {
            try {
                const response = await fetch('/api/custom_cryptos/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ crypto_id: cryptoId })
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`✅ Added ${cryptoId.toUpperCase()} to watchlist`, 'success');
                    document.getElementById('crypto-search').value = '';
                    document.getElementById('search-results').style.display = 'none';
                    refreshDataProgressive(); // Refresh to show updated watchlist
                } else {
                    showMessage('❌ Failed to add crypto: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('❌ Error adding crypto: ' + error.message, 'error');
            }
        }

        async function removeCrypto(cryptoId) {
            try {
                const response = await fetch('/api/custom_cryptos/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ crypto_id: cryptoId })
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`✅ Removed ${cryptoId.toUpperCase()} from watchlist`, 'success');
                    refreshDataProgressive(); // Refresh to show updated watchlist
                } else {
                    showMessage('❌ Failed to remove crypto: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('❌ Error removing crypto: ' + error.message, 'error');
            }
        }

        async function startTrading() {
            try {
                const response = await fetch('/api/start', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showMessage('🚀 Trading started successfully!', 'success');
                    refreshDataProgressive();
                } else {
                    showMessage('❌ Failed to start trading: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('❌ Error starting trading: ' + error.message, 'error');
            }
        }

        async function stopTrading() {
            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showMessage('🛑 Trading stopped successfully!', 'success');
                    refreshDataProgressive();
                } else {
                    showMessage('❌ Failed to stop trading: ' + data.error, 'error');
                }
            } catch (error) {
                showMessage('❌ Error stopping trading: ' + error.message, 'error');
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        async function clearTrades() {
            if (confirm('Are you sure you want to clear all recent trades? This action cannot be undone.')) {
                try {
                    const response = await fetch('/api/trades/clear', { method: 'POST' });
                    const data = await response.json();
                    if (data.success) {
                        showMessage('🗑️ Recent trades cleared successfully!', 'success');
                        refreshTradesData();
                    } else {
                        showMessage('❌ Failed to clear trades: ' + data.error, 'error');
                    }
                } catch (error) {
                    showMessage('❌ Error clearing trades: ' + error.message, 'error');
                }
            }
        }

        function showCustomizationTab() {
            document.getElementById('customization-modal').style.display = 'block';
            document.getElementById('customization-login').style.display = 'block';
            document.getElementById('customization-panel').style.display = 'none';
            document.getElementById('admin-password').value = '';
            document.getElementById('admin-login-error').style.display = 'none';
        }
        function closeCustomizationModal() {
            document.getElementById('customization-modal').style.display = 'none';
        }
        function verifyAdminPassword() {
            const input = document.getElementById('admin-password').value;
            fetch('/api/verify_admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: input })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('customization-login').style.display = 'none';
                    document.getElementById('customization-panel').style.display = 'block';
                    loadCustomizationPanel();
                } else {
                    document.getElementById('admin-login-error').style.display = 'block';
                }
            });
        }
        function logoutAdmin() {
            document.getElementById('customization-login').style.display = 'block';
            document.getElementById('customization-panel').style.display = 'none';
        }
        function loadCustomizationPanel() {
            // Fetch and display trading status and balance
            fetch('/api/status').then(res => res.json()).then(data => {
                document.getElementById('trading-status').innerText = 'Trading Enabled: ' + (data.is_running ? 'Yes' : 'No');
                document.getElementById('bot-balance').innerText = 'Balance: $' + (data.balance || 'N/A');
            });
        }
        function startBot() {
            fetch('/api/start', { method: 'POST' }).then(() => loadCustomizationPanel());
        }
        function stopBot() {
            fetch('/api/stop', { method: 'POST' }).then(() => loadCustomizationPanel());
        }

        // Fetch recent trades from Binance and update the trades table
        async function fetchBinanceTrades(symbol) {
            const binanceSymbol = COINGECKO_TO_BINANCE[symbol] || '';
            const tbody = document.getElementById('modal-trades-tbody');
            if (!binanceSymbol) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#666;padding:12px;">Not available</td></tr>';
                return;
            }
            try {
                const resp = await fetch(`https://api.binance.com/api/v3/trades?symbol=${binanceSymbol}&limit=20`);
                const trades = await resp.json();
                tbody.innerHTML = '';
                trades.forEach(trade => {
                    const price = parseFloat(trade.price);
                    const qty = parseFloat(trade.qty);
                    const time = new Date(trade.time);
                    const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    tbody.innerHTML += `<tr><td style="color:${trade.isBuyerMaker ? '#ff6b6b' : '#00d4aa'};font-weight:600;">$${price.toFixed(2)}</td><td>${qty}</td><td>${timeStr}</td></tr>`;
                });
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#666;padding:12px;">Not available</td></tr>';
            }
        }

        // Close search results when clicking outside
        document.addEventListener('click', function(event) {
            const searchResults = document.getElementById('search-results');
            const searchInput = document.getElementById('crypto-search');
            
            if (!searchResults.contains(event.target) && !searchInput.contains(event.target)) {
                searchResults.style.display = 'none';
            }
        });

        // Close modal when clicking outside
        document.getElementById('crypto-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html> 